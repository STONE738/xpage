<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Phúc Bùi – Tools & Projects</title>
  <meta name="description" content="Kho công cụ cá nhân – macOS style, thêm tool trực tiếp, quản lý dự án." />
  <style>
    :root{
      --bg:#f5f5f7;--txt:#1c1c1e;--muted:#6e6e73;--line:#d2d2d7;
      --card:#fff;--shadow:rgba(0,0,0,.12);
      --accent:#007aff;--accent-2:#0ea5e9;
      --red:#ff5f57;--yellow:#febc2e;--green:#28c840;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--txt);}

    /* Layout */
    .app{display:flex;gap:0;height:100vh}
    .sidebar{width:280px;background:linear-gradient(180deg,#fff,#fbfbfd);border-right:1px solid var(--line);display:flex;flex-direction:column}
    .sb-head{padding:18px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
    .sb-head h1{font-size:16px}
    .sb-body{padding:12px;overflow:auto;flex:1}
    .group{margin-top:8px;margin-bottom:6px;color:var(--muted);font-size:12px;padding:8px 4px}
    .list{display:flex;flex-direction:column;gap:6px}
    .item{padding:8px 10px;border-radius:8px;cursor:pointer;border:1px solid transparent}
    .item:hover{background:#f2f6ff}
    .item.active{background:#e8f2ff;border-color:#d9eaff;font-weight:600}
    .controls{display:flex;gap:8px}
    .btn{padding:8px 10px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:transparent}

    /* Main */
    .main{flex:1;padding:18px;overflow:auto}
    .window{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 30px var(--shadow);overflow:hidden;max-width:1100px;margin:0 auto}
    .titlebar{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid var(--line);background:linear-gradient(to bottom,#fbfbfd,#eef0f3)}
    .dot{width:12px;height:12px;border-radius:50%}
    .dot.red{background:var(--red)}
    .dot.yellow{background:var(--yellow)}
    .dot.green{background:var(--green)}
    .title{flex:1;text-align:left;font-size:15px;font-weight:600}
    .title[contenteditable]{outline: none;}

    .inner{display:grid;grid-template-columns:1fr 420px;gap:12px;padding:14px}
    .panel{background:transparent}
    .editor{display:flex;flex-direction:column;height:520px;border-radius:10px;border:1px solid var(--line);overflow:hidden}
    .editor textarea{flex:1;padding:12px;border:0;resize:vertical;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;font-size:13px}
    .toolbar{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--line);background:#fafafa}
    .preview{height:420px;border-radius:8px;border:1px solid var(--line);overflow:hidden}
    .preview iframe{width:100%;height:100%;border:0}

    .meta{font-size:13px;color:var(--muted);margin-bottom:8px}
    .small{font-size:12px;color:var(--muted)}

    /* Projects list style small */
    .project-item{padding:8px;border-radius:8px;border:1px dashed var(--line);cursor:pointer}

    /* Responsive */
    @media (max-width: 980px){
      .inner{grid-template-columns:1fr}
      .editor{height:420px}
    }

  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sb-head">
        <h1>Phúc Bùi – Tools</h1>
        <div style="display:flex;gap:8px">
          <button class="btn" id="importBtn" title="Import JSON">Import</button>
          <button class="btn" id="exportBtn" title="Export JSON">Export</button>
        </div>
      </div>

      <div class="sb-body">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Tools</div>
          <div class="controls">
            <button class="btn" id="newToolBtn">+ Tool</button>
          </div>
        </div>
        <div class="list" id="toolsList" style="margin-top:8px"></div>

        <div class="group">Dự án</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Projects</div>
          <button class="btn" id="newProjectBtn">+ Project</button>
        </div>
        <div class="list" id="projectsList"></div>

      </div>
    </aside>

    <main class="main">
      <div class="window" id="windowRoot">
        <div class="titlebar">
          <div class="dot red"></div>
          <div class="dot yellow"></div>
          <div class="dot green"></div>
          <div class="title" id="itemTitle" contenteditable="true" title="Click để đổi tên">Trang chủ</div>
          <div style="display:flex;gap:8px">
            <button class="btn" id="saveBtn">Lưu</button>
            <button class="btn" id="deleteBtn">Xóa</button>
          </div>
        </div>

        <div class="inner">
          <div class="panel">
            <div class="meta">Nội dung tool (dán HTML/JS/CSS vào ô bên phải). Sau đó bấm <b>Render</b> để xem.</div>
            <div class="editor">
              <div class="toolbar">
                <button class="btn" id="renderBtn">Render</button>
                <button class="btn" id="saveContentBtn">Lưu nội dung</button>
                <button class="btn" id="clearBtn">Xóa nội dung</button>
                <div style="flex:1"></div>
                <div class="small">Lưu tự động vào localStorage</div>
              </div>
              <textarea id="htmlEditor" placeholder="Dán code HTML/JS/CSS của tool vào đây (ví dụ copy toàn bộ body hay file HTML)." spellcheck="false"></textarea>
            </div>
          </div>

          <div>
            <div class="meta">Xem trước</div>
            <div class="preview" id="previewWrap">
              <iframe id="previewFrame" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>
            <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
              <div class="small">ID: <span id="itemId" class="small muted">-</span></div>
              <div style="flex:1"></div>
              <div class="small">Trạng thái: <span id="status" class="small muted">ready</span></div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <input type="file" id="fileImport" accept="application/json" style="display:none" />

  <script>
    // ======= Data model (localStorage) =======
    // Structure:
    // {
    //   tools: [{id, title, content}],
    //   projects: [{id, title, content}],
    //   active: {type: 'tool'|'project', id}
    // }

    const STORAGE_KEY = 'phuc_tools_v1';

    function uid(prefix='id'){return prefix + '_' + Math.random().toString(36).slice(2,9)}

    function loadState(){
      try{const s = localStorage.getItem(STORAGE_KEY); return s? JSON.parse(s): {tools:[], projects:[], active:{type:'tool', id:null}}}catch(e){console.error(e); return {tools:[],projects:[],active:{type:'tool',id:null}}}
    }
    function saveState(state){localStorage.setItem(STORAGE_KEY, JSON.stringify(state))}

    let state = loadState();

    // Initialize with sample home tool if empty
    function initDefaults(){
      if(state.tools.length===0 && state.projects.length===0){
        const t = {id:uid('tool'), title:'Thời Gian Khai Triển 2D (paste code vào)', content:'<p>Chèn code tool tại đây.</p>'};
        state.tools.push(t);
        state.active = {type:'tool', id:t.id};
        saveState(state);
      }
    }

    initDefaults();

    // ======= UI refs =======
    const toolsList = document.getElementById('toolsList');
    const projectsList = document.getElementById('projectsList');
    const newToolBtn = document.getElementById('newToolBtn');
    const newProjectBtn = document.getElementById('newProjectBtn');
    const itemTitle = document.getElementById('itemTitle');
    const itemId = document.getElementById('itemId');
    const htmlEditor = document.getElementById('htmlEditor');
    const renderBtn = document.getElementById('renderBtn');
    const saveContentBtn = document.getElementById('saveContentBtn');
    const saveBtn = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const previewFrame = document.getElementById('previewFrame');
    const status = document.getElementById('status');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const fileImport = document.getElementById('fileImport');

    // ======= Render sidebar =======
    function renderSidebar(){
      toolsList.innerHTML = '';
      state.tools.forEach(t=>{
        const el = document.createElement('div');
        el.className = 'item' + (state.active.type==='tool' && state.active.id===t.id ? ' active' : '');
        el.textContent = t.title;
        el.title = 'Click để mở. Double-click để đổi tên.';
        el.addEventListener('click', ()=> openItem('tool', t.id));
        el.addEventListener('dblclick', ()=> renameItemInline('tool', t.id, el));
        toolsList.appendChild(el);
      });

      projectsList.innerHTML = '';
      state.projects.forEach(p=>{
        const el = document.createElement('div');
        el.className = 'project-item' + (state.active.type==='project' && state.active.id===p.id ? ' active' : '');
        el.textContent = p.title;
        el.addEventListener('click', ()=> openItem('project', p.id));
        el.addEventListener('dblclick', ()=> renameItemInline('project', p.id, el));
        projectsList.appendChild(el);
      });
    }

    function renameItemInline(type,id,element){
      const list = type==='tool'? state.tools : state.projects;
      const item = list.find(x=>x.id===id);
      if(!item) return;
      const input = document.createElement('input');
      input.value = item.title;
      input.style.width = '100%';
      input.style.padding = '6px';
      element.innerHTML = '';
      element.appendChild(input);
      input.focus();
      input.select();
      input.addEventListener('blur', ()=>{ item.title = input.value || 'Untitled'; saveState(state); renderSidebar(); });
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ input.blur(); } });
    }

    // ======= Open item =======
    function openItem(type,id){
      state.active = {type, id};
      saveState(state);
      renderSidebar();
      const list = type==='tool'? state.tools : state.projects;
      const item = list.find(x=>x.id===id);
      if(!item) return;
      itemTitle.textContent = item.title;
      itemId.textContent = item.id;
      htmlEditor.value = item.content || '';
      previewFrame.srcdoc = item.content || '<p>Preview</p>';
    }

    // ======= Create new =======
    newToolBtn.addEventListener('click', ()=>{
      const t = {id:uid('tool'), title:'New Tool', content:'<p>Chèn code ở đây.</p>'};
      state.tools.unshift(t);
      state.active = {type:'tool', id:t.id};
      saveState(state); renderSidebar(); openItem('tool', t.id);
    });

    newProjectBtn.addEventListener('click', ()=>{
      const p = {id:uid('proj'), title:'New Project', content:'<p>Mô tả dự án</p>'};
      state.projects.unshift(p);
      state.active = {type:'project', id:p.id};
      saveState(state); renderSidebar(); openItem('project', p.id);
    });

    // ======= Save title (inline) =======
    itemTitle.addEventListener('blur', ()=>{
      const active = state.active; if(!active.id) return;
      const list = active.type==='tool'? state.tools : state.projects;
      const item = list.find(x=>x.id===active.id);
      if(!item) return;
      item.title = itemTitle.textContent.trim() || 'Untitled';
      saveState(state); renderSidebar();
    });

    itemTitle.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); itemTitle.blur(); } });

    // ======= Render preview & save content =======
    renderBtn.addEventListener('click', ()=>{
      previewFrame.srcdoc = htmlEditor.value || '<p>Preview</p>'; status.textContent = 'rendered';
    });

    saveContentBtn.addEventListener('click', ()=>{
      const active = state.active; if(!active.id) return;
      const list = active.type==='tool'? state.tools : state.projects;
      const item = list.find(x=>x.id===active.id);
      if(!item) return;
      item.content = htmlEditor.value;
      saveState(state);
      status.textContent = 'saved';
      renderSidebar();
    });

    saveBtn.addEventListener('click', ()=>{ saveContentBtn.click(); alert('Đã lưu.'); });

    clearBtn.addEventListener('click', ()=>{ if(confirm('Xóa nội dung hiện tại?')){ htmlEditor.value = ''; previewFrame.srcdoc = '<p>Preview</p>'; status.textContent = 'cleared'; } });

    deleteBtn.addEventListener('click', ()=>{
      if(!state.active.id) return; if(!confirm('Xóa item này?')) return;
      const {type,id} = state.active;
      if(type==='tool') state.tools = state.tools.filter(t=>t.id!==id); else state.projects = state.projects.filter(p=>p.id!==id);
      // set new active
      const next = state.tools[0] || state.projects[0];
      if(next){ if(state.tools.find(t=>t.id===next.id)) state.active = {type:'tool', id:next.id}; else state.active = {type:'project', id:next.id}; }
      else state.active = {type:'tool', id:null};
      saveState(state);
      renderSidebar();
      if(state.active.id) openItem(state.active.type, state.active.id); else { itemTitle.textContent='Trang chủ'; itemId.textContent='-'; htmlEditor.value=''; previewFrame.srcdoc='<p>Preview</p>'; }
    });

    // ======= Export / Import =======
    exportBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'phuc-tools-backup.json'; a.click(); URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', ()=> fileImport.click());
    fileImport.addEventListener('change', ()=>{
      const f = fileImport.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = e=>{
        try{ const imported = JSON.parse(e.target.result); if(imported.tools && imported.projects){ state = imported; saveState(state); renderSidebar(); if(state.active.id) openItem(state.active.type, state.active.id); alert('Import thành công'); } else alert('File không hợp lệ'); }
        catch(err){alert('Import lỗi: '+err.message)}
      }; reader.readAsText(f);
    });

    // ======= Init =======
    renderSidebar();
    if(state.active && state.active.id){ openItem(state.active.type, state.active.id); }

    // Auto-save content while typing (throttle)
    let typingTimer = null;
    htmlEditor.addEventListener('input', ()=>{
      clearTimeout(typingTimer);
      typingTimer = setTimeout(()=>{
        const active = state.active; if(!active.id) return;
        const list = active.type==='tool'? state.tools : state.projects;
        const item = list.find(x=>x.id===active.id);
        if(!item) return; item.content = htmlEditor.value; saveState(state); status.textContent = 'auto-saved';
      }, 800);
    });

    // Keyboard shortcuts: Ctrl/Cmd+S to save content
    window.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveContentBtn.click(); }
    });

  </script>
</body>
</html>
